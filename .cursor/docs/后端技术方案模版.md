## **1. 需求背景与目标 (Context & Goal)**
*   **目的：** 清晰说明**为什么**要做这个需求，解决什么具体问题。
*   **描述：**
    *   **业务诉求：** (1-2句话) 简述原始业务需求。
    *   **技术目标：** 本次改动需要达成的**具体技术结果** (e.g., 新增XX接口、修改YY逻辑、优化ZZ性能、修复BUG)。
    *   **影响范围：** 明确改动涉及哪些**现有**模块/服务/表/接口。
*   **示例：**
    
    > *   **业务诉求：** 用户参与秒杀活动前，需增加"风险用户"校验（如频繁取消订单、有作弊历史的用户禁止参与）。
    > *   **技术目标：** 在现有秒杀流程中，新增前置风险校验环节，对命中规则的用户返回错误。
    > *   **影响范围：** `秒杀服务` (流程修改)、`风控服务` (新增规则查询接口)、`用户服务` (可能需提供用户标签)。

## **2. 详细设计方案 (Core Design)**
*   **目的：** 聚焦**如何实现**这个具体需求，核心是改动点本身。

### 2.1 流程图/时序图
清晰展示新逻辑如何嵌入现有流程。标注新增/修改的步骤。

### 2.2 接口文档
<!-- 
说明：
- 每个接口（无论是新增还是修改）都应作为一个独立的四级标题（####）。
- 标题格式为 `2.2.x [接口名称] (新增/修改)`，以便在大纲中清晰可见。
- 如果是修改接口，请务必在文档末尾附上【兼容性说明】和【变更点】。
-->

#### 2.2.1 用户风险校验接口 (新增)
【接口名称】：用户风险校验接口
【接口路径】：/api/risk/check
【请求方式】：POST
【接口描述】：检查用户是否有风险行为，判断是否允许参与秒杀活动

            【请求参数】：

| 参数名称   | 类型 | 是否必须 | 默认值 | 描述       |
| ---------- | ---- | -------- | ------ | ---------- |
| userId     | Long | 是       | 无     | 用户ID     |
| activityId | Long | 是       | 无     | 秒杀活动ID |
            
            【响应参数】：

| 参数名称  | 类型    | 描述                                |
| --------- | ------- | ----------------------------------- |
| isAllowed | Boolean | 是否允许参与，true=允许，false=拒绝 |
| reason    | String  | 拒绝原因，当isAllowed=false时有值   |
              
            【错误码说明】：

| 错误码 | 错误信息      | 描述         |
| ------ | ------------- | ------------ |
| 10001  | PARAM_ERROR   | 参数错误     |
| 20001  | SERVICE_ERROR | 服务内部错误 |
              
            【请求示例】：
            ```json
            {
  "userId": 123456,
  "activityId": 789012
            }
            ```
            
            【响应示例】：
            ```json
            {
  "isAllowed": false,
  "reason": "高频取消订单"
            }
            ```

---

#### 2.2.2 [接口名称] (新增/修改)
【接口名称】：
【接口路径】：
【请求方式】：
【接口描述】：

【请求参数】：

| 参数名称 | 类型 | 是否必须 | 默认值 | 描述 |
| :--- | :--- | :--- | :--- | :--- |
|      |      |      |      |      |

【响应参数】：

| 参数名称 | 类型 | 描述 |
| :--- | :--- | :--- |
|      |      |      |

【错误码说明】：

| 错误码 | 错误信息 | 描述 |
| :--- | :--- | :--- |
|      |      |      |

【请求示例】：
```json
{
}
```

【响应示例】：
```json
{
}
```

<!-- 如果是修改接口，请务必在文档末尾附上以下内容 -->
【兼容性说明】：
            【变更点】：
*   ...

### 2.3 数据模型变更 (DB/Cache)
        *   **新增表/字段：** DDL 语句片段或字段描述。
        *   **修改表/字段：** 说明变更内容及影响 (e.g., 字段类型变更、非空约束)。
        *   **缓存变更：** 新增/失效哪些缓存？Key 规则？失效策略？

### 2.4 核心逻辑/算法
*   描述**新增或修改**的业务规则、算法逻辑 (伪代码或清晰描述)。

### 2.5 关键配置
*   新增或需要修改的配置项 (e.g., 风控规则开关、阈值)。

*   **示例：**
    
    > *   **时序图 (片段 - 新增风控校验)：**
    >     
    >     ```
    >     用户 -> 秒杀服务: 秒杀请求
    >     秒杀服务 -> 风控服务: 调用 /api/risk/check (同步, 新增！) [入参: userId, activityId]
    >     风控服务 --> 秒杀服务: 返回 { "isAllowed": false, "reason": "高频取消订单" } (新增！)
    >     秒杀服务 --> 用户: 返回错误码 "RISK_DENIED" (修改！)
    >     (原库存扣减等步骤不再执行)
    >     ```
    > *   **风控服务新增接口：**
    >
    >     【接口名称】：用户风险校验接口
    >     【接口路径】：/api/risk/check
    >     【请求方式】：POST
    >     【接口描述】：检查用户是否有风险行为，判断是否允许参与秒杀活动
    >     
    >     【请求参数】：
    >     | 参数名称   | 类型 | 是否必须 | 默认值 | 描述       |
    >     | ---------- | ---- | -------- | ------ | ---------- |
    >     | userId     | Long | 是       | 无     | 用户ID     |
    >     | activityId | Long | 是       | 无     | 秒杀活动ID |
    >     
    >     【响应参数】：
    >     | 参数名称  | 类型    | 描述                                |
    >     | --------- | ------- | ----------------------------------- |
    >     | isAllowed | Boolean | 是否允许参与，true=允许，false=拒绝 |
    >     | reason    | String  | 拒绝原因，当isAllowed=false时有值   |
    >     
    >     【错误码说明】：
    >     | 错误码 | 错误信息      | 描述         |
    >     | ------ | ------------- | ------------ |
    >     | 10001  | PARAM_ERROR   | 参数错误     |
    >     | 20001  | SERVICE_ERROR | 服务内部错误 |
    >     
    >     【请求示例】：
    >     ```json
    >     {
    >       "userId": 123456,
    >       "activityId": 789012
    >     }
    >     ```
    >     
    >     【响应示例】：
    >     ```json
    >     {
    >       "isAllowed": false,
    >       "reason": "高频取消订单"
    >     }
    >     ```
    > *   **数据变更：** `无` (假设风控规则是动态配置或实时计算)。
    > *   **核心逻辑：** 风控服务 `/check` 接口逻辑：查询该用户在该活动上的风险标签（如调用用户服务或查风控结果表），应用配置的规则（如"近7天取消订单>3次则拒绝"），返回结果。
    > *   **配置变更：** 在配置中心 (`risk-service`) 新增规则：`seckill.deny.cancelOrder.threshold=3` (近7天取消订单>3次则拒绝)。

## **3. 关联影响与风险评估 (Impact & Risk)**
*   **目的：** 评估改动对**现有系统**的影响和潜在风险。

### 3.1 兼容性
        *   **接口兼容性：** 修改的接口是否**向后兼容**？是否需要上下游同步升级？如何平滑过渡？
        *   **数据兼容性：** 数据变更是否兼容老数据？是否需要数据迁移/转换脚本？

### 3.2 性能影响
*   新增逻辑 (e.g., 远程调用、复杂计算) 对接口 RT、QPS 的影响预估？是否需要优化或补偿措施？

### 3.3 依赖方
*   哪些其他服务/模块/前端需要配合修改？沟通计划？

### 3.4 回滚方案
*   如果上线失败，如何**快速、安全**地回滚到旧版本？回滚步骤？

### 3.5 关键风险
*   列出 1-3 个最可能的风险点及预案 (e.g., 风控服务宕机怎么办？新规则误杀率过高怎么办？)。

*   **示例：**
    > *   **兼容性：** 秒杀服务调用风控接口是**新增逻辑**，风控接口是**全新接口**，不影响现有功能。秒杀返回的错误码 `RISK_DENIED` 是**新增**，客户端需适配。
    > *   **性能影响：** 新增一次同步 RPC 调用。**评估：** 风控服务需能支撑秒杀峰值流量 (10万QPS)。**措施：** 风控接口需做高性能设计 (缓存规则结果？)，风控服务需扩容并压测。
    > *   **依赖方：** 前端需适配新错误码 `RISK_DENIED` 的展示。
    > *   **回滚方案：**
    >     1.  秒杀服务版本回滚到旧版 (关闭风控校验)。
    >     2.  风控服务新接口下线。
    >     3.  (可选) 配置中心关闭风控规则开关 (如果设计有开关)。
    > *   **关键风险：**
    >     *   **风险1：** 风控服务在高并发下宕机或响应慢，拖垮秒杀服务。
    >         *   **应对：** 秒杀服务调用风控接口时设置**超时** (e.g., 50ms) 和**熔断** (e.g., 错误率>10%熔断10s)，熔断时**降级放行** (默认允许参与)。
    >     *   **风险2：** 新规则上线初期误判率高，导致大量正常用户被拒。
    >         *   **应对：** 上线前在预发/灰度环境充分测试规则；上线时配置**动态开关**可快速关闭单条规则；提供**白名单**机制。

## **4. 测试要点 (Testing Focus)**
*   **目的：** 明确如何**精准测试**本次改动，覆盖核心场景和风险点。

### 4.1 功能测试
        *   新功能核心场景 (e.g., 触发风控被拒、未触发风控正常下单)。
        *   边界值/异常值 (e.g., 用户无标签、风控服务不可用)。
        *   **回归测试：** 确保**未改动**的原有秒杀主流程依然正常。

### 4.2 性能测试
*   重点压测**涉及改动的接口** (e.g., 秒杀接口新增调用风控后的RT/QPS，风控新接口的RT/QPS)。

### 4.3 兼容性测试
*   验证接口/数据变更的兼容性 (如果涉及)。

### 4.4 开关/降级测试
*   验证配置开关、熔断降级、白名单等容错机制是否生效。

*   **示例：**
    > *   **功能测试用例：**
    >     *   用户近7天取消订单=4次 (>3) 尝试秒杀 -> 返回 `RISK_DENIED`。
    >     *   用户近7天取消订单=2次 (<3) 尝试秒杀 -> 正常进入后续流程。
    >     *   调用风控服务超时 (模拟) -> 熔断降级 -> 允许用户参与 (日志记录)。
    >     *   风控服务返回错误 (非超时) -> 记录错误日志，默认**拒绝** (保守策略，可讨论)。
    > *   **性能测试：** 在秒杀压测场景中，监控 `/api/risk/check` 接口的 P99 RT 和错误率，确保符合预期 (e.g., RT < 20ms, 错误率 < 0.1%)。

## **5. 上线计划 (Rollout Plan)**
*   **目的：** 清晰可控的发布步骤。

### 5.1 依赖发布顺序
*   先发风控服务 (新接口) -> 再发秒杀服务 (新逻辑) -> 最后发前端 (新错误码)。

### 5.2 发布策略
*   蓝绿/金丝雀发布？灰度比例？**监控指标** (重点关注：错误日志、风控接口RT/QPS、熔断状态、秒杀成功率)。

### 5.3 配置生效
*   新规则何时在配置中心发布？是否有**灰度启用**计划？

### 5.4 数据迁移/初始化
*   如果需要，脚本和时机。

### 5.5 回滚触发条件
*   明确哪些监控指标异常触发回滚 (e.g., 风控接口错误率>5%持续5分钟，秒杀失败率陡升)。

*   **示例：**
    > 1.  **预发环境：** 全量部署验证。
    > 2.  **生产环境：**
    >     *   步骤1：发布 `风控服务` V1.1 (包含新接口 `/api/risk/check`)。
    >     *   步骤2：**灰度发布** `秒杀服务` V2.0 (10%流量) -> **密切监控** 秒杀接口错误率、熔断器状态、风控接口 RT/QPS。
    >     *   步骤3：灰度期间无异常 -> **全量发布** `秒杀服务` V2.0。
    >     *   步骤4：在配置中心发布**初始风控规则** `seckill.deny.cancelOrder.threshold=3` (默认**关闭**状态)。
    >     *   步骤5：通过配置中心**动态开启**规则 (先开1%活动观察误判率)。
    >     *   步骤6：前端发布适配新错误码 (可稍后)。
    > 3.  **回滚条件：** 秒杀服务 V2.0 灰度期间，若因风控问题导致秒杀失败率上升 >2%，立即回滚秒杀服务至 V1.0，并关闭风控规则。
